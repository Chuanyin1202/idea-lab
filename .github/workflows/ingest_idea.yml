name: Ingest IdeaBrowser Idea

on:
  # æ¯æ—¥ UTC 02:00 åŸ·è¡Œï¼ˆå°ç£æ™‚é–“ 10:00ï¼‰
  schedule:
    - cron: "0 2 * * *"

  # æ”¯æ´æ‰‹å‹•è§¸ç™¼ï¼ˆæ¸¬è©¦ç”¨ï¼‰
  workflow_dispatch:

jobs:
  ingest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Setup Gmail OAuth credentials
        env:
          GMAIL_TOKEN_JSON: ${{ secrets.GMAIL_TOKEN_JSON }}
        run: |
          # Gmail token å°‡ç”±ç’°å¢ƒè®Šæ•¸è™•ç†ï¼Œä¸éœ€è¦å¯«å…¥æª”æ¡ˆ
          echo "âœ… Gmail OAuth credentials configured"

      - name: Run ingest script
        env:
          # OpenAI API Key
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

          # Gmail OAuth Token (Base64 ç·¨ç¢¼)
          GMAIL_TOKEN_JSON: ${{ secrets.GMAIL_TOKEN_JSON }}

        run: |
          cd ${{ github.workspace }}
          python scripts/ingest_idea.py --env

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
          if [ -n "$(git status --porcelain)" ]; then
            echo "âœ… åµæ¸¬åˆ°æ–°çš„ ideaï¼Œæº–å‚™æäº¤..."

            git add ideas/ SUMMARY.md

            # å–å¾—æ–°å¢çš„ idea æ¨™é¡Œï¼ˆå¾æœ€æ–°çš„ç›®éŒ„åç¨±ï¼‰
            LATEST_IDEA=$(ls -td ideas/*/ | head -1 | xargs basename)
            echo "ğŸ“ æ–°å¢ idea: $LATEST_IDEA"

            git commit -m "$(cat <<'EOF'
chore: add daily idea - $LATEST_IDEA

ğŸ¤– Auto-generated by IdeaBrowser ingestion workflow
EOF
)"

            git push
            echo "âœ… æ¨é€æˆåŠŸ"
          else
            echo "â„¹ï¸  æ²’æœ‰æ–°çš„ idea"
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Workflow åŸ·è¡Œå¤±æ•—"
          echo "è«‹æª¢æŸ¥ï¼š"
          echo "  1. OPENAI_API_KEY æ˜¯å¦æ­£ç¢º"
          echo "  2. GMAIL_TOKEN_JSON æ˜¯å¦æ­£ç¢º"
          echo "  3. Gmail API æ¬Šé™æ˜¯å¦è¶³å¤ "
          echo "  4. Token æ˜¯å¦éæœŸï¼ˆéœ€è¦é‡æ–°æˆæ¬Šï¼‰"
